<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Docs</title>

    <!-- Your global dark theme -->
    <link rel="stylesheet" href="style.css" />

    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="48x48" href="img/favicon.ico" />
    <!-- Apple Touch Icon for iOS -->
    <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png" />
    <!-- Meta tags for SEO -->
    <meta name="description" content="Documentation for programming tools and technologies" />
    <meta name="keywords" content="documentation, programming, git, python, ssh, technical docs" />

    <!-- GitHub‑style Markdown base - load asynchronously -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@5/github-markdown.min.css" media="print" onload="this.media='all'">

    <!-- Highlight.js theme - load asynchronously -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" media="print" onload="this.media='all'">

    <style>
        /* Critical CSS for initial render */
        .markdown-body {
            background: #fdf6e3;
            color: #111 !important;
            max-width: 800px;
            margin: 2em auto;
            padding: 2em;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-shadow: 0 0 16px rgba(0, 0, 0, 0.2);
        }

        /* Docs sub‑tab bar */
        .docs-nav {
            max-width: 800px;
            margin: 0.5rem auto;
            display: flex;
            gap: 1rem;
            justify-content: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0;
        }

        .docs-nav a {
            font-size: 1.3rem;
            padding: 0.2rem 0.5rem;
            color: var(--text-color-light);
            text-decoration: none;
            transition: color 0.3s;
        }

        .docs-nav a:hover {
            color: var(--primary-color);
        }

        .docs-nav a.active {
            background: none;
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 0;
        }
        
        /* Loading indicator */
        .loading-indicator {
            text-align: center;
            padding: 2em;
            color: var(--text-color-light);
        }
    </style>
</head>

<body>

    <!-- Main nav -->
    <header>
        <nav aria-label="Main navigation">
            <div class="nav-left">
                <h1>Emre Acarsoy</h1>
            </div>
            <div class="nav-right">
                <a href="index.html">Home</a>
                <a href="projects.html">Projects</a>
                <a href="docs.html" aria-current="page">Docs</a>
                <a href="music.html">Music</a>
            </div>
        </nav>
    </header>

    <!-- Docs sub‑tabs -->
    <div class="docs-nav">
        <a href="#" data-md="docs_src/docs_landing_page.md" class="active">Overview</a>
        <a href="#" data-md="docs_src/git.md">Git</a>
        <a href="#" data-md="docs_src/python.md">Python</a>
        <a href="#" data-md="docs_src/ssh.md">SSH</a>
    </div>

    <!-- Markdown rendering target -->
    <article class="markdown-body" id="content">
        <div class="loading-indicator">Loading...</div>
    </article>

    <!-- Load scripts at end of body and defer non-critical scripts -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js" defer></script>

    <script>
        // Cache DOM elements
        const contentEl = document.getElementById('content');
        let currentFile = '';
        let markedLoaded = false;
        let hlsjsLoaded = false;
        let pendingLoad = null;

        // Load and initialize libraries
        function initLibraries() {
            if (window.marked) {
                try {
                    window.marked.setOptions({
                        gfm: true,
                        headerIds: true,
                        headerPrefix: '',
                        mangle: false,
                        breaks: true
                    });
                    
                    // Add a custom renderer to properly handle header IDs
                    const renderer = new marked.Renderer();
                    renderer.heading = function(text, level) {
                        // Ensure text is a string before calling toLowerCase
                        const textStr = String(text);
                        const escapedText = textStr.toLowerCase()
                                              .replace(/[^\w\s-]/g, '')
                                              .replace(/\s+/g, '-');
                        return `<h${level} id="${escapedText}">
                                ${text}
                              </h${level}>`;
                    };
                    marked.use({ renderer });
                } catch (e) {
                    console.error('Error configuring marked.js:', e);
                    // Fall back to default marked configuration
                    window.marked.setOptions({
                        gfm: true,
                        breaks: true
                    });
                }
                markedLoaded = true;
            }
            
            if (window.hljs) {
                hlsjsLoaded = true;
            }
            
            // Process any pending load
            if (pendingLoad && markedLoaded && hlsjsLoaded) {
                loadMarkdown(pendingLoad.file, pendingLoad.anchor);
                pendingLoad = null;
            }
        }
        
        // Check if libraries are loaded every 100ms
        const libCheckInterval = setInterval(() => {
            if (!markedLoaded || !hlsjsLoaded) {
                initLibraries();
            } else {
                clearInterval(libCheckInterval);
            }
        }, 100);

        function scrollToAnchor(id) {
            // Ensure id is a string
            if (!id) return false;
            const idStr = String(id);
            
            // First try finding by ID
            const el = document.getElementById(idStr);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth' });
                return true;
            }
            
            // If not found by ID, try finding headers with matching text
            const headers = contentEl.querySelectorAll('h1, h2, h3, h4, h5, h6');
            for (const header of headers) {
                try {
                    // Create a slug from the header text similar to how markdown does it
                    const headerText = String(header.textContent || '');
                    const slug = headerText.trim().toLowerCase()
                        .replace(/[^\w\s-]/g, '') // Remove special chars
                        .replace(/\s+/g, '-');    // Replace spaces with hyphens
                    
                    if (slug === idStr || encodeURIComponent(slug) === idStr) {
                        header.scrollIntoView({ behavior: 'smooth' });
                        return true;
                    }
                } catch (e) {
                    console.error('Error processing header:', e);
                }
            }
            
            return false;
        }

        function toDocsSrc(path) {
            // if it already starts with docs_src/ leave it
            if (path.startsWith('docs_src/')) return path;
            // strip an old src/ prefix if present
            path = path.replace(/^src\//, '');
            // Handle relative links within markdown files
            if (path.startsWith('./')) {
                // Get the directory of the current file
                const currentDir = currentFile.substring(0, currentFile.lastIndexOf('/') + 1);
                return currentDir + path.substring(2);
            }
            // Check if it's a simple filename without path
            if (!path.includes('/') && path.endsWith('.md')) {
                // If it's just a filename.md, assume it's in the same directory as current file
                if (currentFile.includes('/')) {
                    const currentDir = currentFile.substring(0, currentFile.lastIndexOf('/') + 1);
                    return currentDir + path;
                }
            }
            // Otherwise, prepend docs_src/
            return 'docs_src/' + path;
        }

        // Use event delegation instead of attaching to each link
        function setupContentClickHandler() {
            contentEl.addEventListener('click', (e) => {
                // Only handle clicks on links
                if (e.target.tagName === 'A') {
                    const href = e.target.getAttribute('href');
                    if (!href) return;
                    
                    const mdMatch = href.match(/^(.+\.md)(?:#(.+))?$/);
                    if (mdMatch) {
                        e.preventDefault();
                        
                        /* normalize the file path */
                        const file = toDocsSrc(mdMatch[1]);
                        const anchor = mdMatch[2] || null;
                        
                        /* highlight matching tab if we have it */
                        const tab = document.querySelector(`.docs-nav a[data-md="${file}"]`);
                        if (tab) {
                            document.querySelectorAll('.docs-nav a').forEach(x => x.classList.remove('active'));
                            tab.classList.add('active');
                        }
                        
                        /* update URL & load */
                        history.replaceState(null, '', '#' + file + (anchor ? '#' + anchor : ''));
                        loadMarkdown(file, anchor);
                    } else if (href.startsWith('#')) {
                        e.preventDefault();
                        const section = href.slice(1);
                        scrollToAnchor(section);
                        history.replaceState(null, '', '#' + currentFile + '#' + section);
                    }
                }
            });
        }

        // Add cache version to handle updates
        const CACHE_VERSION = '1.0.1';
        
        function loadMarkdown(file, anchor) {
            // If libraries aren't loaded yet, save this load for later
            if (!markedLoaded || !hlsjsLoaded) {
                pendingLoad = { file, anchor };
                contentEl.innerHTML = '<div class="loading-indicator">Loading libraries...</div>';
                return;
            }
            
            currentFile = file;
            contentEl.innerHTML = '<div class="loading-indicator">Loading content...</div>';
            
            // Use a cached version if available
            const cacheKey = 'docs_cache_' + CACHE_VERSION + '_' + file;
            const cachedContent = sessionStorage.getItem(cacheKey);
            if (cachedContent) {
                contentEl.innerHTML = cachedContent;
                if (anchor) setTimeout(() => scrollToAnchor(anchor), 100);
                return;
            }

            // Clear any old cache entries
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                if (key && key.startsWith('docs_cache_') && !key.includes(CACHE_VERSION)) {
                    sessionStorage.removeItem(key);
                }
            }

            fetch('./' + file)
                .then(r => { 
                    if (!r.ok) throw new Error(r.status); 
                    return r.text();
                })
                .then(md => {
                    try {
                        const parsedHtml = marked.parse(md);
                        contentEl.innerHTML = parsedHtml;
                        
                        // Cache the result for future use
                        sessionStorage.setItem(cacheKey, parsedHtml);
                        
                        // Apply syntax highlighting only to visible code blocks
                        setTimeout(() => {
                            contentEl.querySelectorAll('pre code').forEach(block => {
                                hljs.highlightElement(block);
                            });
                            
                            if (anchor) setTimeout(() => scrollToAnchor(anchor), 100);
                        }, 0);
                    } catch (err) {
                        console.error('Error parsing markdown:', err);
                        contentEl.innerHTML = '<div class="loading-indicator">Error parsing markdown: ' + err.message + '</div>';
                    }
                })
                .catch(err => { 
                    console.error('Error loading docs:', err);
                    contentEl.innerHTML = '<div class="loading-indicator">Error loading docs: ' + err + '</div>';
                });
        }

        function activateTab(tab) {
            document.querySelectorAll('.docs-nav a').forEach(a => a.classList.remove('active'));
            tab.classList.add('active');
        }

        // Set up event delegation for docs tabs
        document.querySelector('.docs-nav').addEventListener('click', (e) => {
            if (e.target.tagName === 'A') {
                e.preventDefault();
                activateTab(e.target);
                history.replaceState(null, '', '#' + e.target.dataset.md);
                loadMarkdown(e.target.dataset.md, null);
            }
        });

        // Handle hash changes
        window.addEventListener('hashchange', () => {
            const full = location.hash.slice(1);
            const m = full.match(/^(.+\.md)(?:#(.+))?$/);
            if (m) {
                const file = m[1], anchor = m[2] || null;
                const tab = document.querySelector(`.docs-nav a[data-md="${file}"]`);
                if (tab) activateTab(tab);
                loadMarkdown(file, anchor);
            } else if (full) {
                scrollToAnchor(full);
            }
        });

        // Initialize on DOM content loaded
        document.addEventListener('DOMContentLoaded', () => {
            setupContentClickHandler();
            
            const full = location.hash.slice(1);
            const m = full.match(/^(.+\.md)(?:#(.+))?$/);
            let file = m ? m[1] : document.querySelector('.docs-nav a').dataset.md;
            let anchor = m ? m[2] : null;
            const starter = document.querySelector(`.docs-nav a[data-md="${file}"]`)
                || document.querySelector('.docs-nav a');
            activateTab(starter);
            
            // Start loading markdown after a short delay
            setTimeout(() => {
                loadMarkdown(file, anchor);
                initLibraries();
            }, 0);
        });
    </script>
</body>

</html>